(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{448:function(e,t,a){"use strict";a.r(t);var s=a(34),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"tutorial-four-secure-your-application-by-adding-authentication-authorization"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tutorial-four-secure-your-application-by-adding-authentication-authorization"}},[e._v("#")]),e._v(" Tutorial Four: Secure your application by adding authentication & authorization")]),e._v(" "),a("p",[e._v("What if you wanted to restrict access to one of the routes in your application? For example, you might want to have all users be able to READ information but only a select few that can UPDATE. In this case, you will want to secure your application by adding authentication and authorization.")]),e._v(" "),a("ul",[a("li",[a("em",[e._v("Authentication")]),e._v(" is the process of determining a user's identity, or if someone is who they say they are.")]),e._v(" "),a("li",[a("em",[e._v("Authorization")]),e._v(" is the process of deciding whether a user has access to a resource, or if someone - based on their authenticated identity - can do or see something protected.")])]),e._v(" "),a("h2",{attrs:{id:"pre-requisites"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pre-requisites"}},[e._v("#")]),e._v(" Pre-requisites")]),e._v(" "),a("ul",[a("li",[e._v("Completed "),a("RouterLink",{attrs:{to:"/tutorials/crud.html"}},[e._v("Tutorial Two: My First CRUD App")])],1)]),e._v(" "),a("h2",{attrs:{id:"overview"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[e._v("#")]),e._v(" Overview")]),e._v(" "),a("p",[e._v("You may associate security with login pages and passwords. In the world of APIs, however, we authenticate and authorize our users without visual interfaces")]),e._v(" "),a("h3",{attrs:{id:"why-authenticate-using-jwt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#why-authenticate-using-jwt"}},[e._v("#")]),e._v(" Why authenticate using JWT?")]),e._v(" "),a("p",[e._v("JWT (JSON Web Tokens) is a way of sending information as a JSON token that is digitally signed using a secret. The signature certifies that only the party with the private key was the signer, allowing for authentication.")]),e._v(" "),a("p",[e._v("In this case, no identity or user information will be managed by the app directly. Instead, the app will receive a JWT token that contains all needed resources for authentication.")]),e._v(" "),a("h3",{attrs:{id:"what-does-jwt-look-like-in-asp-net-core"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-does-jwt-look-like-in-asp-net-core"}},[e._v("#")]),e._v(" What does JWT look like in ASP.NET Core?")]),e._v(" "),a("ol",[a("li",[e._v("The Client (the user) authenticates itself to the Server (your application)")]),e._v(" "),a("li",[e._v("If authentication is successful, Server creates a JWT token and sends it to the Client")]),e._v(" "),a("li",[e._v("Client signs the token and sends it to the Server whenever it needs authorization to access protected resources")]),e._v(" "),a("li",[e._v("Server authorizes the Client by getting and validating the token. Client gets access to the secured data.")])]),e._v(" "),a("h3",{attrs:{id:"configuring-jwt-bearer-authentication"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configuring-jwt-bearer-authentication"}},[e._v("#")]),e._v(" Configuring JWT Bearer Authentication")]),e._v(" "),a("p",[e._v("Before we start implementing the logic of JWT authentication, however, we need to configure our app to use it. We will use the package "),a("code",[e._v("Microsoft.AspNetCore.Authentication.JwtBearer")]),e._v(", which adds middleware that allows an application to get a Bearer Token in the Request Pipeline.")]),e._v(" "),a("p",[e._v("Install the packages "),a("code",[e._v("Microsoft.AspNetCore.Authentication.JwtBearer")]),e._v("and "),a("code",[e._v("Microsoft.AspNetCore.Authorization")]),e._v(".")]),e._v(" "),a("p",[a("code",[e._v("dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer")])]),e._v(" "),a("p",[a("code",[e._v("dotnet add package Microsoft.AspNetCore.Authorization")])]),e._v(" "),a("p",[e._v("Then, import the namespaces into your application by including these lines of code at the top of your "),a("code",[e._v("Program.cs")]),e._v(" file:")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("using Microsoft.AspNetCore.Authentication.JwtBearer;\nusing Microsoft.AspNetCore.Authorization; \n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("Under "),a("code",[e._v("builder.Services.AddSwaggerGen")]),e._v(", where you added the Swagger service, include the authentication and authorization services for the desired authentication scheme.")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)\n    .AddJwtBearer(jwtConfig =>\n    {\n        jwtConfig.Authority = "https://example.com";\n        jwtConfig.TokenValidationParameters = new()\n        {\n            ValidAudience = "MyAudience",\n            ValidIssuer = "https://example.com"\n        };\n    });\nbuilder.Services.AddAuthorization();\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br")])]),a("blockquote",[a("p",[e._v("The authentication scheme is added and configured using an "),a("em",[e._v("options configuration delegate")]),e._v(" which passes along information about the audience and issuer.")])]),e._v(" "),a("p",[e._v("Under where you built your app using "),a("code",[e._v("var app = builder.Build();")]),e._v(", add the middleware for authentication authorization:")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("// Add the authentication and authorization middleware\napp.UseAuthentication();\napp.UseAuthorization();\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("blockquote",[a("p",[e._v("These lines of code must be included in the right order i.e. the authentication middleware must be included before the authorization middleware in order for the API to be successfully protected.")])]),e._v(" "),a("p",[e._v("Finally, you will want to add authorization configuration to the API. On the route you want to secure, add the following code:")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('app.MapGet("secured-route", () => "Hello, you are authorized to see this!")\n    .RequireAuthorization();\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"create-and-verify-jwt-tokens"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-and-verify-jwt-tokens"}},[e._v("#")]),e._v(" Create and verify JWT tokens")]),e._v(" "),a("p",[e._v("A JSON Web Token (JWT) is a way of transferring information as a JSON object. Before you add authentication and authorization to your application, you will want to have a way to create the token that the user will pass to the server to authenticate its identity, and a way for your server to authorize the user based on the contents of that token.")]),e._v(" "),a("p",[e._v("A detailed tutorial on setting up your own discrete server for issuing and verifying JWT tokens is in progress. In the meantime, look at")]),e._v(" "),a("h3",{attrs:{id:"securing-our-app-with-jwt-bearer-authentication"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#securing-our-app-with-jwt-bearer-authentication"}},[e._v("#")]),e._v(" Securing our app with JWT Bearer Authentication")]),e._v(" "),a("p",[e._v("In "),a("RouterLink",{attrs:{to:"/tutorials/crud.html"}},[e._v("Tutorial 2")]),e._v(", we allow users to CREATE, READ, UPDATE, and DELETE using our app. Let's say we want to stil let all users READ, but restrict access to the CREATE endpoint to only authorized requests. In other words, only users who are authenticated can make new todos. Add the attribute to the "),a("code",[e._v("/todos")]),e._v(" endpoint, as in the code below.")],1),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('\n//post method\napp.MapPost("/todos", [Authorize] async (TodoDb db, TodoItem todo) =>\n{\n    await db.Todos.AddAsync(todo);\n    await db.SaveChangesAsync();\n    return Results.Created($"/todo/{todo.Id}", todo);\n});\n\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[e._v("Let's go ahead and start our API. Call this endpoint without providing a valid "),a("code",[e._v("access_token")]),e._v(" in the "),a("code",[e._v("Authorization")]),e._v(" header, like:")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("curl -X 'POST' \\\n  'http://localhost:[YOUR_PORT_NAME]/todos' \\\n  -H 'accept: */*' \\\n  -H 'Content-Type: application/json' \\\n  --header 'Authorization: Bearer [INVALID_TOKEN]' \\\n  -d '{\n  \"id\": 1,\n  \"item\": \"Buy groceries\",\n  \"isComplete\": true\n}'\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br")])]),a("p",[e._v("We will fail with the following error:")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('{\n  "error": "invalid_token",\n  "error_description": "This request requires a valid JWT access token to be provided"\n}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("Now try that same request with a valid token in the "),a("code",[e._v("Authorization")]),e._v(" header. You should have been able to POST the item successfully and received a "),a("code",[e._v("Response body")]),e._v(" which includes the item you just added.")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('[\n  {\n    "id": 1,\n    "item": "Buy groceries",\n    "isComplete": true\n  }\n]\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])])])}),[],!1,null,null,null);t.default=n.exports}}]);