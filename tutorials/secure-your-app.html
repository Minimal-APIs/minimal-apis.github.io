<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tutorial Four: Secure your application by adding authentication &amp; authorization | Minimal APIs</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Building APIs in C#">
    <meta name="theme-color" content="#d9C5C1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.c9c98798.css" as="style"><link rel="preload" href="/assets/js/app.ac332cf9.js" as="script"><link rel="preload" href="/assets/js/2.2bd089a4.js" as="script"><link rel="preload" href="/assets/js/24.6c0b92de.js" as="script"><link rel="prefetch" href="/assets/js/10.5d8d1e81.js"><link rel="prefetch" href="/assets/js/11.add2209d.js"><link rel="prefetch" href="/assets/js/12.7aa50d5b.js"><link rel="prefetch" href="/assets/js/13.d91548c1.js"><link rel="prefetch" href="/assets/js/14.40f9daca.js"><link rel="prefetch" href="/assets/js/15.afaafacf.js"><link rel="prefetch" href="/assets/js/16.0c95cc17.js"><link rel="prefetch" href="/assets/js/17.06f7bb9b.js"><link rel="prefetch" href="/assets/js/18.0e07dd6a.js"><link rel="prefetch" href="/assets/js/19.5e96ddbc.js"><link rel="prefetch" href="/assets/js/20.eba95d43.js"><link rel="prefetch" href="/assets/js/21.e40cf0df.js"><link rel="prefetch" href="/assets/js/22.cd43dcc4.js"><link rel="prefetch" href="/assets/js/23.8da194c6.js"><link rel="prefetch" href="/assets/js/3.2e7fa9cd.js"><link rel="prefetch" href="/assets/js/4.9d8f745a.js"><link rel="prefetch" href="/assets/js/5.0ac92ac3.js"><link rel="prefetch" href="/assets/js/6.1fae0437.js"><link rel="prefetch" href="/assets/js/7.2d00f8e9.js"><link rel="prefetch" href="/assets/js/8.aecd003b.js"><link rel="prefetch" href="/assets/js/9.4a670d5b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9c98798.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Minimal APIs" class="logo"> <span class="site-name can-hide">Minimal APIs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/hello-minimal/" class="nav-link">
  Hello Minimal
</a></div><div class="nav-item"><a href="/quickstart/" class="nav-link">
  Getting Started
</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link router-link-active">
  Tutorials
</a></div><div class="nav-item"><a href="https://github.com/Minimal-APIs/samples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Samples
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://docs.microsoft.com/aspnet/core/fundamentals/minimal-apis" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Microsoft Docs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/hello-minimal/" class="nav-link">
  Hello Minimal
</a></div><div class="nav-item"><a href="/quickstart/" class="nav-link">
  Getting Started
</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link router-link-active">
  Tutorials
</a></div><div class="nav-item"><a href="https://github.com/Minimal-APIs/samples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Samples
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://docs.microsoft.com/aspnet/core/fundamentals/minimal-apis" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Microsoft Docs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Tutorials</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tutorials/" aria-current="page" class="sidebar-link">Tutorials</a></li><li><a href="/tutorials/first-steps.html" class="sidebar-link">Tutorial One: Minimal APIs 101</a></li><li><a href="/tutorials/crud.html" class="sidebar-link">Tutorial Two: My First CRUD App</a></li><li><a href="/tutorials/databases.html" class="sidebar-link">Tutorial Three: Add a Database</a></li><li><a href="/tutorials/secure-your-app.html" aria-current="page" class="active sidebar-link">Tutorial Four: Secure your application by adding authentication &amp; authorization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tutorials/secure-your-app.html#pre-requisites" class="sidebar-link">Pre-requisites</a></li><li class="sidebar-sub-header"><a href="/tutorials/secure-your-app.html#overview" class="sidebar-link">Overview</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tutorial-four-secure-your-application-by-adding-authentication-authorization"><a href="#tutorial-four-secure-your-application-by-adding-authentication-authorization" class="header-anchor">#</a> Tutorial Four: Secure your application by adding authentication &amp; authorization</h1> <p>What if you wanted to restrict access to one of the routes in your application? For example, you might want to have all users be able to READ information but only a select few that can UPDATE. In this case, you will want to secure your application by adding authentication and authorization.</p> <ul><li><em>Authentication</em> is the process of determining a user's identity, or if someone is who they say they are.</li> <li><em>Authorization</em> is the process of deciding whether a user has access to a resource, or if someone - based on their authenticated identity - can do or see something protected.</li></ul> <h2 id="pre-requisites"><a href="#pre-requisites" class="header-anchor">#</a> Pre-requisites</h2> <ul><li>Completed <a href="/tutorials/crud.html">Tutorial Two: My First CRUD App</a></li></ul> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>You may associate security with login pages and passwords. In the world of APIs, however, we authenticate and authorize our users without visual interfaces</p> <h3 id="why-authenticate-using-jwt"><a href="#why-authenticate-using-jwt" class="header-anchor">#</a> Why authenticate using JWT?</h3> <p>JWT (JSON Web Tokens) is a way of sending information as a JSON token that is digitally signed using a secret. The signature certifies that only the party with the private key was the signer, allowing for authentication.</p> <p>In this case, no identity or user information will be managed by the app directly. Instead, the app will receive a JWT token that contains all needed resources for authentication.</p> <h3 id="what-does-jwt-look-like-in-asp-net-core"><a href="#what-does-jwt-look-like-in-asp-net-core" class="header-anchor">#</a> What does JWT look like in ASP.NET Core?</h3> <ol><li>The Client (the user) authenticates itself to the Server (your application)</li> <li>If authentication is successful, Server creates a JWT token and sends it to the Client</li> <li>Client signs the token and sends it to the Server whenever it needs authorization to access protected resources</li> <li>Server authorizes the Client by getting and validating the token. Client gets access to the secured data.</li></ol> <h3 id="configuring-jwt-bearer-authentication"><a href="#configuring-jwt-bearer-authentication" class="header-anchor">#</a> Configuring JWT Bearer Authentication</h3> <p>Before we start implementing the logic of JWT authentication, however, we need to configure our app to use it. We will use the package <code>Microsoft.AspNetCore.Authentication.JwtBearer</code>, which adds middleware that allows an application to get a Bearer Token in the Request Pipeline.</p> <p>Install the packages <code>Microsoft.AspNetCore.Authentication.JwtBearer</code>and <code>Microsoft.AspNetCore.Authorization</code>.</p> <p><code>dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer</code></p> <p><code>dotnet add package Microsoft.AspNetCore.Authorization</code></p> <p>Then, import the namespaces into your application by including these lines of code at the top of your <code>Program.cs</code> file:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Authorization; 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Under <code>builder.Services.AddSwaggerGen</code>, where you added the Swagger service, include the authentication and authorization services for the desired authentication scheme.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(jwtConfig =&gt;
    {
        jwtConfig.Authority = &quot;https://example.com&quot;;
        jwtConfig.TokenValidationParameters = new()
        {
            ValidAudience = &quot;MyAudience&quot;,
            ValidIssuer = &quot;https://example.com&quot;
        };
    });
builder.Services.AddAuthorization();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>The authentication scheme is added and configured using an <em>options configuration delegate</em> which passes along information about the audience and issuer.</p></blockquote> <p>Under where you built your app using <code>var app = builder.Build();</code>, add the middleware for authentication authorization:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// Add the authentication and authorization middleware
app.UseAuthentication();
app.UseAuthorization();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>These lines of code must be included in the right order i.e. the authentication middleware must be included before the authorization middleware in order for the API to be successfully protected.</p></blockquote> <p>Finally, you will want to add authorization configuration to the API. On the route you want to secure, add the following code:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app.MapGet(&quot;secured-route&quot;, () =&gt; &quot;Hello, you are authorized to see this!&quot;)
    .RequireAuthorization();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="create-and-verify-jwt-tokens"><a href="#create-and-verify-jwt-tokens" class="header-anchor">#</a> Create and verify JWT tokens</h3> <p>A JSON Web Token (JWT) is a way of transferring information as a JSON object. Before you add authentication and authorization to your application, you will want to have a way to create the token that the user will pass to the server to authenticate its identity, and a way for your server to authorize the user based on the contents of that token.</p> <p>A detailed tutorial on setting up your own discrete server for issuing and verifying JWT tokens is in progress. In the meantime, look at</p> <h3 id="securing-our-app-with-jwt-bearer-authentication"><a href="#securing-our-app-with-jwt-bearer-authentication" class="header-anchor">#</a> Securing our app with JWT Bearer Authentication</h3> <p>In <a href="/tutorials/crud.html">Tutorial 2</a>, we allow users to CREATE, READ, UPDATE, and DELETE using our app. Let's say we want to stil let all users READ, but restrict access to the CREATE endpoint to only authorized requests. In other words, only users who are authenticated can make new todos. Add the attribute to the <code>/todos</code> endpoint, as in the code below.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
//post method
app.MapPost(&quot;/todos&quot;, [Authorize] async (TodoDb db, TodoItem todo) =&gt;
{
    await db.Todos.AddAsync(todo);
    await db.SaveChangesAsync();
    return Results.Created($&quot;/todo/{todo.Id}&quot;, todo);
});

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Let's go ahead and start our API. Call this endpoint without providing a valid <code>access_token</code> in the <code>Authorization</code> header, like:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>curl -X 'POST' \
  'http://localhost:[YOUR_PORT_NAME]/todos' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  --header 'Authorization: Bearer [INVALID_TOKEN]' \
  -d '{
  &quot;id&quot;: 1,
  &quot;item&quot;: &quot;Buy groceries&quot;,
  &quot;isComplete&quot;: true
}'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>We will fail with the following error:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;error&quot;: &quot;invalid_token&quot;,
  &quot;error_description&quot;: &quot;This request requires a valid JWT access token to be provided&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Now try that same request with a valid token in the <code>Authorization</code> header. You should have been able to POST the item successfully and received a <code>Response body</code> which includes the item you just added.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[
  {
    &quot;id&quot;: 1,
    &quot;item&quot;: &quot;Buy groceries&quot;,
    &quot;isComplete&quot;: true
  }
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/tutorials/databases.html" class="prev">
        Tutorial Three: Add a Database
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ac332cf9.js" defer></script><script src="/assets/js/2.2bd089a4.js" defer></script><script src="/assets/js/24.6c0b92de.js" defer></script>
  </body>
</html>
